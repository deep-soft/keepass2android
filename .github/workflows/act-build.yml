# 2024-02-22
#
#

name: act-Build keepass2android app

#on: [push, pull_request]
on:
  workflow_dispatch

jobs:
  windows:
    # on windows-2022 it builds with:
    #    Microsoft Visual Studio\2022\Enterprise
    #    Found Java SDK version 11.0.12
    #    Found Xamarin.Android 13.1.0.1
    #
    runs-on: windows-2022

    steps:
    - uses: deep-soft/checkout@v4

    - name: Setup Gradle
      uses: deep-soft/gradle-build-action@v3

    - name: Cache NuGet packages
      uses: deep-soft/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('src/**/*.csproj', 'src/**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Fetch submodules
      run: |
        git submodule init && git submodule update

    # Workaround an issue when building on windows-2022. Error was
    #       D8 : OpenJDK 64-Bit Server VM warning : INFO: os::commit_memory(0x00000000ae400000, 330301440, 0) failed; error='The paging file is too small for this operation to complete' (DOS error/errno=1455) [D:\a\keepass2android\keepass2android\src\keepass2android\keepass2android-app.csproj]
    #       C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Xamarin\Android\Xamarin.Android.D8.targets(81,5): error MSB6006: "java.exe" exited with code 1. [D:\a\keepass2android\keepass2android\src\keepass2android\keepass2android-app.csproj]
    - name: Configure Pagefile
      uses: deep-soft/configure-pagefile-action@v1.4
      with:
        minimum-size: 8GB

    - name: Add msbuild to PATH
      uses: deep-soft/setup-msbuild@v1.3
      # If we want to also have nmake, use this instead
      #uses: ilammy/msvc-dev-cmd@v1

    - name: Switch to JDK-11
      uses: deep-soft/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Display java version
      run: |
        java -version

    # Some components of Keepass2Android currently target android API 26 which are not available on the runner
    - name: Download android-26 API
      shell: cmd
      run: |
        %ANDROID_SDK_ROOT%\cmdline-tools\latest\bin\sdkmanager --install "platforms;android-26"

    - name: Build native dependencies
      shell: cmd
      run: |
        make native

    - name: Build java dependencies
      shell: cmd
      run: |
        make java

    - name: Install NuGet dependencies (net)
      run: 
        make nuget Flavor=Net

    - name: Build keepass2android (net)
      run: |
        make msbuild Flavor=Net

    - name: Build APK (net)
      run: |
        make apk Flavor=Net

    - name: Archive production artifacts (net)
      uses: deep-soft/upload-artifact@v4
      with:
        name: signed APK ('net' built on ${{ github.job }})
        path: |
          src/keepass2android/bin/*/*-Signed.apk

    - name: Install NuGet dependencies (nonet)
      run: make nuget Flavor=NoNet

    - name: Build keepass2android (nonet)
      run: |
        make msbuild Flavor=NoNet

    - name: Test Autofill
      working-directory: ./src/Kp2aAutofillParserTest
      run: |
        dotnet test

    - name: Build APK (nonet)
      run: |
        make apk Flavor=NoNet

    - name: Archive production artifacts (nonet)
      uses: deep-soft/upload-artifact@v4
      with:
        name: signed APK ('nonet' built on ${{ github.job }})
        path: |
          src/keepass2android/bin/*/*-Signed.apk

    - name: Perform "make distclean"
      run: make distclean
